<script type="text/javascript">
    RED.nodes.registerType('google-credentials', {
        category: 'config',
        defaults: {
            name: { value: '' },

            redirect_uri: {
                value: 'http://localhost:1880/google-credentials/auth/callback',
                required: true,
            },
            scopes: { value: 'https://www.googleapis.com/auth/drive' },
        },
        credentials: {
            client_id: { type: 'text' },
            client_secret: { type: 'password' },
        },
        label: function () {
            return this.name || 'Google Credentials';
        },
        oneditprepare: function () {

            const node = this;
            const nameInput = $('#node-input-name');
            const clientIdInput = $('#node-config-input-client_id');
            const clientSecretInput = $('#node-config-input-client_secret');
            const redirectUriInput = $('#node-config-input-redirect_uri');
            const scopesInput = $('#node-config-input-scopes');
            const startAuthButton = $('#node-config-start-auth');
            const hasTokenCheckbox = $('#check_token');
            const hasRefreshTokenCheckbox = $('#check_refresh_token');
            const inputTokenExpiry = $('#input_token_expiry');
            const inputRefreshTokenExpiry = $('#input_refresh_token_expiry');

            if (node.name) {
                nameInput.val(node.name);
            }

            if (node.redirect_uri) {
                redirectUriInput.val(node.redirect_uri);
            }

            if (node.scopes) {
                scopesInput.val(node.scopes);
            }

            if (node.credentials?.client_id) {
                clientIdInput.val(node.credentials.client_id);
            }
            
            // Helper to enable or disable the auth button based on input fields
            const enableDisableAuthButton = function () {
                let clientIdValue = clientIdInput.val();
                let has_client_secret = node.credentials.has_client_secret;
                let redirectUriValue = redirectUriInput.val();
                let scopesValue = scopesInput.val();
                var buttonEnabled = [clientIdValue, redirectUriValue, scopesValue].every((v) => v && v.length > 0) && has_client_secret;

                startAuthButton.prop('disabled', !buttonEnabled);
            };

            clientIdInput.on('keyup', enableDisableAuthButton);
            clientSecretInput.on('keyup', enableDisableAuthButton);
            redirectUriInput.on('keyup', enableDisableAuthButton);
            scopesInput.on('keyup', enableDisableAuthButton);

            startAuthButton.on('click', function () {
                let clientIdValue = clientIdInput.val();
                let redirectUriValue = redirectUriInput.val();
                let scopesValue = scopesInput.val();
                let clientSecretValue = node.credentials.has_client_secret;

                // Ensure all fields are filled
                let hasAllfields = [clientIdValue, redirectUriValue, scopesValue].every((v) => v && v.length > 0) && clientSecretValue;
                if (!hasAllfields) return;

                const urlParts = [`/google-credentials/auth?id=${node.id}&`];
                urlParts.push(`clientId=${encodeURIComponent(clientIdValue)}&`);
                urlParts.push(`callback=${encodeURIComponent(redirectUriValue)}&`);
                urlParts.push(`scopes=${encodeURIComponent(scopesValue)}`);

                const url = urlParts.join('');
                window.open(url, '_blank');
            });


            $.get('/google-credentials/' + this.id + '/status').done((data) => {
                if (data.expiry_date) {
                    inputTokenExpiry.val(new Date(data.expiry_date).toISOString());
                }
                if (data.refresh_token_expiry_date) {
                    inputRefreshTokenExpiry.val(new Date(data.refresh_token_expiry_date).toISOString());
                }
                if (data.has_access_token === true) {
                    hasTokenCheckbox.prop('checked', true);
                }
                if (data.has_refresh_token === true) {
                    hasRefreshTokenCheckbox.prop('checked', true);
                }
            });

            enableDisableAuthButton();
        },
    });
</script>

<script type="text/html" data-template-name="google-credentials">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-config-input-client_id"><i class="fa fa-key"></i> Client ID</label>
        <input type="text" id="node-config-input-client_id" placeholder="Enter Google OAuth Client ID" />
    </div>
    <div class="form-row">
        <label for="node-config-input-client_secret"><i class="fa fa-lock"></i> Client Secret</label>
        <input type="password" id="node-config-input-client_secret" placeholder="Enter Google OAuth Client Secret" />
    </div>
    <div class="form-row">
        <label for="node-config-input-redirect_uri"><i class="fa fa-reply"></i> Redirect URI</label>
        <input type="text" id="node-config-input-redirect_uri" placeholder="http://localhost:1880/auth/google/callback" />
    </div>
    <div class="form-row">
        <label for="node-config-input-scopes"><i class="fa fa-list"></i> Scopes</label>
        <input type="text" id="node-config-input-scopes" placeholder="https://www.googleapis.com/auth/drive" />
    </div>
    <div class="form-row" style="font-size: 80%; color: #777777; padding-top:20px; max-width:500px; line-height:1em;">
        Note: the button is enabled after filling in all required fields and deploying the config node.
    </div>
    <div class="form-row">
        <button type="button" class="btn" id="node-config-start-auth">Start Authorization</button>
        <div id="node-config-auth-url" style="margin-top: 10px;"></div>
    </div>
    <div class="form-row" style="font-size: 80%; color: #777777; padding-top:20px; max-width:500px; line-height:1em;">
        <div>Note: After completing authorization, you may need to refresh this dialog to see updated token status.</div>
    </div>
    <div class="form-row">
        <label>Has token</label>
        <input type="checkbox" id="check_token" disabled readonly />
    </div>
    <div class="form-row">
        <label>Token expires at</label>
        <input type="text" id="input_token_expiry" disabled readonly />
    </div>

    <div class="form-row">
        <label>Has refresh token</label>
        <input type="checkbox" id="check_refresh_token" disabled readonly />
    </div>
    <div class="form-row">
        <label>Refresh token expires at</label>
        <input type="text" id="input_refresh_token_expiry" disabled readonly />
    </div>
</script>

<script type="text/html" data-help-name="google-credentials">
    
</script>
